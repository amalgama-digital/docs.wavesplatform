# Вычисления с продолжением

Если сложность dApp-скрипта превышает 4000, его выполнение разбивается на несколько транзакций. Добавляя в блок транзакцию вызова скрипта, генерирующая нода выполняет порцию вычислений, суммарная сложность которых не превышает 4000, и сохраняет промежуточные результаты во внутренней базе данных. Далее генерирующая нода — та же самая или другая, если уже появился новый блок — обнаруживает незавершенную цепочку вычислений, создает транзакцию продолжения и добавляет ее в блок, выполняя следующую порцию вычислений. Процесс продолжается, пока скрипт не будет выполнен полностью или не завершится ошибкой.

Описание транзакции продолжения см. в разделе [Транзакция продолжения](/ru/blockchain/transaction-type/continuation-transaction).

![](./_assets/continuation.png)

## Условия

* Возможность выполнения скрипта с продолжением доступна начиная с версии ноды 1.3.0 после активации фичи №&nbsp;16 “Continuations”. Версии 1.3.x в настоящее время доступны только на [Stagenet](/ru/blockchain/blockchain-network/).
* dApp-cкрипт использует [Стандартную библиотеку](/ru/ride/script/standard-library) **версии 5**.
* [Транзакция вызова скрипта](/ru/blockchain/transaction) имеет версию 3.

## Приостановка других транзакций с участием dApp

Пока цепочка вычислений не завершена, те транзакции, которые могут уменьшить баланс dApp, могут быть добавлены в [UTX pool](/ru/blockchain/transaction/#utx-pool), но не могут быть добавлены в блок:

* Транзакции, отправителем которых является dApp.
* Транзакции вызова скрипта того же dApp.
* Транзакции обмена, в которых отправителем одного из ордеров является dApp.
* Транзакции с комиссией в спонсорском ассете, выпущенном dApp.

При этом любые переводы в пользу dApp, лизинги и отмены лизинга разрешены.

## Данные блокчейна при выполнении скрипта

### 1. Записи в собственном хранилище данных dApp

Благодаря приостановке других транзакций с участием dApp (см. выше) записи в хранилище данных dApp не меняются до завершения выполнения скрипта. Скрипт dApp может получить их на любом этапе вычислений, то есть в любой из транзакций цепочки вычислений, с помощью следующих функций:

| Название | Описание |
| :--- | :--- |
| getBinary(String): ByteVector&#124;Unit | Получает значение бинарной записи по ключу |
| getBinaryValue(String): ByteVector | Получает значение бинарной записи по ключу; завершается ошибкой, если запись отсутствует |
| getBoolean(String): Boolean&#124;Unit | Получает значение логической записи по ключу |
| getBooleanValue(String): Boolean | Получает значение логической записи по ключу; завершается ошибкой, если запись отсутствует |
| getInteger(String): Int&#124;Unit | Получает значение целочисленной записи по ключу |
| getIntegerValue(String): Int | Получает значение целочисленной записи по ключу; завершается ошибкой, если запись отсутствует |
| getString(String): String&#124;Unit | Получает значение строковой записи по ключу |
| getStringValue(String): String | Получает значение строковой записи по ключу; завершается ошибкой, если запись отсутствует |

Описание функций см. в разделе [Функции хранилища данных аккаунта](/ru/ride/functions/built-in-functions/account-data-storage-functions).

### 2. Внешние данные блокчейна

К внешним данным относятся все данные блокчейна, кроме записей в собственном хранилище данных dApp, в том числе:

* Записи в хранилищах данных других аккаунтов.
* Балансы аккаунтов, в том числе аккаунта самого dApp.
* Текущая высота блокчейна.
* Параметры ассетов, заголовки блоков, транзакции и др.

Все внешние данные блокчейна, используемые скриптом dApp, должны быть получены на первом этапе вычислений, то есть в изначальной транзакции вызова скрипта. Благодаря этому вычисления всех этапов проводятся с одними и теми же данными.

Cложность части скрипта от начала и до последней функции чтения внешних данных включительно не должна превышать 4000.

> Если скрипт содержит ветвления, в момент установки скрипта неизвестно, какая из веток будет выполнена. Поэтому учитывается суммарная сложность по всем веткам. Рассмотрим следующую схему: если операции `op2`, `op-a2` и `op-b3` читают внешние данные блокчейна, то общая сложность операций
`op1 + op2 + op-a1 + op-a2 + op-b1 + op-b2 + op-b3` не должна превышать 4000, иначе dApp-скрипт не может быть установлен.

![](./_assets/continuation-init.png)

## Комиссии

Минимальная комиссия, которую должен указать отправитель в транзакции вызова скрипта, рассчитывается по формуле:

`Fee` = (0,005 + `E`) × ⌈`С` / 4000⌉ × + `S` + 0,004 × `P` + 0,004 × `A` + `I`,

где:

   `E` (extra) — надбавка к комиссии за каждый этап вычислений. Отправитель указывает надбавку в поле `extraFeePerStep`. Надбавка предназначена для повышения приоритета обработки транзакции.

   `C` (complexity) — сложность скрипта,

   `S` (sender) = 0,004, если отправитель транзакции —  [dApp](/ru/blockchain/account/dapp) или [смарт-аккаунт](/ru/blockchain/account/smart-account), и 0 в ином случае,

   `P` (payment) — количество платежей в [смарт-ассетах](/ru/blockchain/token/smart-asset),

   `A` (action) — количество действий скрипта (переводов, довыпусков, сжиганий) со смарт-ассетами,

   `I` (issue) — количество выпущенных скриптом токенов, не являющихся [NFT](/ru/blockchain/token/non-fungible-token).

Отправитель должен учесть в комиссии максимально возможное количество этапов вычислений (сложностью по 4000) и действий скрипта.

Вся сумма комиссии, указанная в транзакции, взимается с отправителя при добавлении транзакции вызова скрипта в блок. Если комиссия указана в спонсорском ассете, со спонсора взимается эквивалент комиссии в WAVES.

Комиссия за выполнение транзакций распределяется следующим образом:

1. За транзакцию вызова скрипта: 0,005 + `E` + `S`.
2. За каждую транзакцию продолжения, кроме последней: 0,005 + `E`.
3. За последнюю транзакцию продолжения: 0,005 + `E` + 0,004 × `P` + 0,004 × `A` + `I`.

(В соответствии с протоколом [Waves-NG](/ru/blockchain/waves-protocol/waves-ng-protocol) 40% комиссии получает генератор блока, в который добавлена транзакция, и 60% комиссии — генератор следующего блока.)

После завершения вычислений неиспользованная часть комиссии возвращается отправителю. Если комиссия указана в спонсорском ассете, спонсору возвращается эквивалент этой части комиссии в WAVES.

> [Порог для сохранения неуспешных транзакций](/ru/ride/limits/) действует только для транзакции вызова скрипта. Если вычисления завершились ошибкой или [выбрасыванием исключения](/ru/ride/exceptions) в рамках транзакции продолжения, она сохраняется на блокчейне как неуспешная и за нее взимается комиссия.

**Рассмотрим пример:**
* Сложность вызываемой функции — 10000.
* Надбавка `E` равна 0,002 WAVES.
* Вызываемая функция выполняет два перевода смарт-ассета, а также выпуск токена.

Минимальная комиссия за транзакцию вызова скрипта (0,005 + 0,002) × 3 + 0,004 × 2 + 1 = 1,029 WAVES. Если все транзакции будут выполнены успешно, комиссия будет распределена следующим образом:
- за транзакцию вызова скрипта 0,005 + 0,002,
- за первую транзакцию продолжения 0,005 + 0,002,
- за вторую транзакцию продолжения 0,005 + 0,002 + 0,004 × 2 + 1.

Если первая транзакция продолжения завершится ошибкой, отправитель заплатит (0,005 + 0,002) × 2 = 0,014 WAVES. Остаток 1,015 WAVES будет ему возвращен.

## Статус выполнения транзакции

Поле `applicationStatus` в JSON-представлении транзакции содержит статус выполнения вычислений:

* для всех транзакций в цепочке вычислений, кроме последней: `script_execution_in_progress`,
* для последней транзакции — `succeeded` в случае успеха или `script_execution_failed` в случае ошибки.
