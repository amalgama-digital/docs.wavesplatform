# Вызов dApp из dApp

Вызываемая функция dApp-скрипта может вызывать вызываемую функцию другого dApp или того же самого dApp, в том числе сама себя. Вызов является синхронным. Вызываемая функция возвращает значение, которое вызываемая функция может использовать.

Вызов dApp из dApp осуществляется следующим образом:

1. Пользователь отправляет транзакцию вызова скрипта, которая вызывает вызываемую функцию 1.
2. Вызываемая функция 1 вызывает вызываемую функцию 2 с помощью [нетерпеливой переменной](/ru/ride/v5/variables/) и функции [Invoke](/ru/ride/v5/functions/built-in-functions/dapp-to-dapp).
3. Вызываемая функция 2 выполняется; вычисляются действия скрипта и [возвращаемое значение](/ru/ride/v5/functions/callable-function#invokation-result).
4. Возвращаемое значение присваивается нетерпеливой переменной. Последующие операции вызываемой функции 1 выполняются с учетом действий скрипта вызываемой функции 2 (как если бы эти действия были применены на блокчейне).
5. В завершение, действия скрипта вызываемых функций 2 и 1 применяются на блокчейне.

Особенности:

* Вызовы dApp из dApp могут быть вложенными.
* Вызов dApp из dApp может содержать платежи, которые будут переведены с баланса вызываемого dApp на баланс вызываемого.
* Все вызванные функции выполняются в рамках одной транзакции вызова скрипта.

## Условия

* Вызовы dApp из dApp добавлены в версии ноды 1.3.0 и включаются с активацией фичи №&nbsp;16 “Continuations”. Версии 1.3.x в настоящее время доступны только для [Stagenet](/ru/blockchain/blockchain-network/).
* Скрипт вызывающего dApp использует [Стандартную библиотеку](/ru/ride/script/standard-library) **версии 5**.
* [Транзакция вызова скрипта](/ru/blockchain/transaction) имеет версию 3.
* Общая сложность всех вызываемых функций и скриптов ассета — не более 52,000. Сложность скрипта аккаунта-отправителя не учитывается в этом лимите.

## Комиссия

Минимальная комиссия за транзакцию вызова скрипта увеличивается на 0,005 WAVES за каждый вызов dApp из dApp.

## Функция Invoke

```
Invoke(dApp: Address|Alias, function: String, arguments: List[Boolean|ByteVector|Int|String|List[Boolean|ByteVector|Int|String]], payments: List[AttachedPayments]): T|Unit
```

| Параметр | Описание |
| :--- | :--- |
| dApp: [Address](/ru/ride/v5/structures/common-structures/address)&#124;[Alias](/ru/ride/v5/structures/common-structures/alias) | [Адрес](/ru/blockchain/account/address) или [псевдоним](/ru/blockchain/account/alias) dApp, функция которого вызывается |
| function: [String](/ru/ride/v5/data-types/string) | Имя вызываемой функции |
| arguments | [List](/ru/ride/v5/data-types/list)[[Boolean](/ru/ride/v5/data-types/boolean)&#124;[ByteVector](/ru/ride/data-types/byte-vector)&#124;[Int](/ru/ride/data-types/int)&#124;[String](/ru/ride/data-types/string)&#124;[List](/ru/ride/data-types/list)[[Boolean](/ru/ride/data-types/boolean)&#124;[ByteVector](/ru/ride/data-types/byte-vector)&#124;[Int](/ru/ride/data-types/int)&#124;[String](/ru/ride/data-types/string)]] | Параметры вызываемой функции |
| payments: [List](/ru/ride/data-types/list)[[AttachedPayment](/ru/ride/structures/common-structures/attached-payment)] | Платежи в пользу вызываемого dApp, не более 2 |

Пример:

```
strict z = Invoke(dapp,func,args,[AttachedPayment(unit,100000000)])
```

## Структуры Invocation

В случае вызова dApp из dApp поля структуры [Invocation](/ru/ride/v5/structures/common-structures/invocation), которую может использовать вызываемая функция, заполняются следующими значениями:

|   #   | Название | Тип данных | Описание |
| :--- | :--- | :--- | :--- |
| 1 | caller | [Address](/ru/ride/v5/structures/common-structures/address) | [Адрес](/ru/blockchain/account/address) dApp, который вызвал функцию |
| 2 | callerPublicKey | [ByteVector](/ru/ride/v5/data-types/byte-vector) | Открытый ключ аккаунта dApp, который вызвал функцию |
| 3 | payments | List[[AttachedPayment](/ru/ride/v5/structures/common-structures/attached-payment)] | Платежи, указанные в функции `Invoke` |
| 4 | transactionId | [ByteVector](/ru/ride/v5/data-types/byte-vector) | ID транзакции вызова скрипта |
| 5 | fee | [Int](/ru/ride/v5/data-types/int) | Комиссия за транзакцию вызова скрипта |
| 6 | feeAssetId | [ByteVector](/ru/ride/v5/data-types/byte-vector)&#124;[Unit](/ru/ride/v5/data-types/unit) | ID токена, в котором указана комиссия |

## Результат вызываемой функции

В Стандартной  библиотеке версии 5 результат выполнения вызываемой функции представляет собой [кортеж](/ru/ride/v5/tuple) из двух элементов:
* Список действий скрипта.
* Возвращаемое значение, которое передается в вызывающую функцию.

Пример:

```
(
   [
      ScriptTransfer(i.caller,100,unit)
   ],
   42
)
```

В Стандартной библиотеке версии 4 или 3 возвращаемого значения нет, поэтому подразумевается `unit`.

### Неуспешные транзакции

Если выполнение вызываемой функции завершается ошибкой или [выбрасыванием исключения](/ru/ride/v5/functions/built-in-functions/exception-functions), транзакция вызова скрипта может быть отклонена или сохранена на блокчейне как неуспешная. Это зависит от того, превысила ли сложность выполненных вычислений [порог для сохранения неуспешных транзакций](/ru/ride/v5/limits/), который сейчас равен 1000. Сложность суммируется по всем вызовам.

Рассмотрим пример: вызываемая функция 1 выполняет вычисления сложностью 800, затем вызывает вызываемую функцию 2, которая выполняет вычисления сложностю 300 и завершается ошибкой. Сложность 800 + 300 превышает порог, поэтому транзакция сохраняется как неуспешная и с отправителя взимается комиссия.

Если общая сложность выполненных вызываемых функций и скриптов ассета превысила ограничение 52&nbsp;000, транзакция также сохраняется как неуспешная. Например, если общая сложность выполненных вызываемых функций составила 50&nbsp;000 и в действиях скрипта есть смарт-ассет, у которого сложность скрипта составляет 2500.

В случае если транзакция неуспешна, никакие платежи и действия скрипта не применяются, даже если некоторые вызванные функции выполнены полностью. Единственное изменение на блокчейне, которое вносит неуспешная транзакция, — взимание комиссии с отправителя.
