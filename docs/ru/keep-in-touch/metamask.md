# Подписание транзакций и ордеров в MetaMask (Stagenet)

[Metamask](https://metamask.io/) — расширение для браузера, популярное у пользователей Ethereum. MetaMask выполняет функции криптовалютного кошелька и обеспечивает взаимодействие с децентрализованными приложениями.

Чтобы привлечь пользователей MetaMask на блокчейн Waves, в протокол Waves были добавлены поддержка транзакций в формате Ethereum и ордеров с подписью ECDSA в транзакции обмена. В результате пользователям MetaMask стали доступны:
* перевод токенов — как системного токена WAVES, так и пользовательских;
* вызов dApp-скрипта;
* подписание биржевого ордера.

Поддержка MetaMask добавлена в версии ноды 1.4.0 и включается с активацией фичи №&nbsp;17 “Ride V6”. Версии 1.4.x в настоящее время доступны только для [Stagenet](/ru/blockchain/blockchain-network/).

## Адрес пользователя

Адрес пользователя MetaMask состоит из 20 байт. Адрес в формате Waves также содержит 20 значимых байт, к которым добавляется префикс, общий для всех адресов сети, и контрольная сумма (см. также раздел [Бинарный формат адреса](/ru/blockchain/binary-format/address-binary-format)). Таким образом, каждому адресу в MetaMask соответствует единственный адрес Waves и наоборот: одни и те же 20 байт используются как адрес в Ethereum-представлении и как основа адреса в формате Waves.

В интерфейсах адрес пользователя MetaMask представлен в 16-ричном формате HEX, а адрес Waves — в base58. Для преобразования адреса из одного формата в другой можно использовать [Waves Explorer](/ru/ecosystem/waves-explorer/).

## Подключение к сети Waves

Нода Waves предоставляет RPC API с поддержкой функций, необходимых для работы MetaMask.

Чтобы подключиться, пользователь выбирает в списке сетей «Пользовательский RPC» и указывает параметры подключения:
* Имя сети — например, Waves Stagenet.
* URL RPC — адрес ноды Waves с открытым RPC API, например адрес пула публичных нод `https://nodes-stagenet.wavesnodes.com/`
* Идентификатор цепочки (сети блокчейна) — 83 для Stagenet.
* Символ валюты — WAVES.

В результате MetaMask отображает сеть Waves в качестве доступной.

Подключение к сети Waves также может быть выполнено программно. Например, веб-приложение может использовать библиотеку [Signer](/ru/building-apps/waves-api-and-sdk/client-libraries/signer) совместно с ProviderMetaMask: 
1. Приложение вызывает метод `login()`.
2. Signer вызывает соответствующий метод ProviderMetaMask, а ProviderMetaMask вызывает API MetaMask.
3. MetaMask открывает окно, в котором пользователь подтверждает подключение к сети.
4. Получив подтверждение, MetaMask добавляет подключение к сети, а также возвращает адрес пользователя.

## Перевод токена

Чтобы выполнить перевод токена из кошелька MetaMask, пользователю необходимо:

1. Подключить сеть Waves (см. выше).
2. Баланс системного токена WAVES отображается автоматически. Чтобы добавить отображение баланса по другому токену, нужно в качестве адреса контракта токена указать ID токена в Ethereum-представлении: первые 20 байт ID токена в кодировке HEX.
3. Перевести токен на другой адрес. Адрес необходимо указать в Ethereum-представлении.

MetaMask формирует транзакцию в формате Ethereum, подписывает ее закрытым ключом пользователя и передает на ноду Waves.

> Пользователи кошельков Waves, таких как Waves.Exchange, WavesFX и других (приложения разработаны сторонними командами из сообщества), могут перевести токены пользователю MetaMask. В некоторых кошельках поддерживаются только адреса в формате Waves, поэтому необходимо предварительно преобразовать адрес получателя. Пользователь увидит полученные токены в MetaMask (для токена, отличного от WAVES, необходимо добавить отображение баланса).

## Вызов скрипта

Веб-приложение может выполнить вызов dApp-скрипта от имени пользователя MetaMask, используя библиотеку [Signer](/ru/building-apps/waves-api-and-sdk/client-libraries/signer) совместно с ProviderMetaMask:

1. Приложение формирует транзакцию вызова скрипта c помощью метода `invoke()` и вызывает метод `broadcast()`.
2. Signer вызывает соответствующий метод ProviderMetaMask, а ProviderMetaMask вызывает API MetaMask.
3. MetaMask открывает окно, в котором пользователь может посмотреть детали транзакции, подтвердить или отклонить ее.
4. Получив подтверждение от пользователя, MetaMask генерирует транзакцию в формате Ethereum c подписью ECDSA и отправляет ее на ноду Waves через RPC API.
5. MetaMask отображает статус транзакции.

Примечания:
- MetaMask не поддерживает подписание транзакции без отправки ее на блокчейн, поэтому метод `sign()` использовать не следует.
- Нода Waves не поддерживает ускорение или отмену транзакции. В результате ускорения будет создана новая транзакция с другим значением `timestamp`, поэтому может оказаться, что на блокчейн добавлены обе транзакции. Отмену транзакции нода отклоняет.

## Особенности транзакции в формате Ethereum

* Транзакция не может быть отправлена со смарт-аккаунта или dApp, поскольку установка скрипта недоступна пользователю MetaMask.
* [Cпонсирование](/ru/blockchain/waves-protocol/sponsored-fee) комиссии недоступно: комиссия может быть указана только в WAVES.

## Биржевой ордер

В транзакции обмена один из ордеров (или оба) может быть с подписью ECDSA. Подпись ECDSA поддерживается только для ордеров версии 4.

1. Клиентский интерфейс биржи передает ордер в MetaMask как структуру данных, в соответствии с [EIP-712](https://eips.ethereum.org/EIPS/eip-712).
2. MetaMask открывает окно, в котором пользователь может посмотреть детали ордера, подписать его или отклонить.
3. MetaMask возвращает подпись ECDSA для этой структуры данных.
4. Клиентский интерфейс передает подписанный ордер в матчер.
5. Матчер исполняет ордера и формирует транзакции обмена.

## Поддержка в Ride

В случае вызова скрипта с помощью Ethereum-транзакции структура [Invocation](/ru/ride/structures/common-structures/invocation) содержит:
- в полях `caller`, `originCaller` — адрес отправителя в формате Waves (26 байт),
- в полях `callerPublicKey`, `originCallerPublicKey` — открытый ключ пользователя MetaMask (64 байта).

В случае верификации скриптом ассета транзакция в формате Ethereum интерпретируется как структура [TransferTransaction](/ru/ride/structures/transaction-structures/transfer-transaction) или [InvokeScriptTransaction](/ru/ride/structures/transaction-structures/invoke-script-transaction):
- в поле `sender` — адрес отправителя в формате Waves (26 байт),
- в поле `senderPublicKey` — открытый ключ пользователя MetaMask (64 байта).
- в поле `bodyBytes` — ????

> Подпись транзакции и ордера недоступна в скрипте ассета.
